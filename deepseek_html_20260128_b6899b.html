<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>CPIL Chennai - Dryer Chamber Analytics</title>
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/chartjs-adapter-date-fns@3.0.0/dist/chartjs-adapter-date-fns.bundle.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/luxon@3.3.0"></script>
    <script src="https://cdn.jsdelivr.net/npm/html2canvas@1.4.1/dist/html2canvas.min.js"></script>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        @keyframes glow {
            0%, 100% { text-shadow: 0 0 10px #0ff; }
            50% { text-shadow: 0 0 20px #0ff; }
        }

        @keyframes pulse {
            0%, 100% { opacity: 1; }
            50% { opacity: 0.7; }
        }

        @keyframes slideIn {
            from { transform: translateY(-10px); opacity: 0; }
            to { transform: translateY(0); opacity: 1; }
        }

        @keyframes fadeIn {
            from { opacity: 0; }
            to { opacity: 1; }
        }

        @keyframes ripple {
            0% { transform: scale(0); opacity: 1; }
            100% { transform: scale(3); opacity: 0; }
        }

        @keyframes cyberGlow {
            0%, 100% { 
                filter: drop-shadow(0 0 5px #0ff) drop-shadow(0 0 10px #0ff);
                transform: translateY(0);
            }
            50% { 
                filter: drop-shadow(0 0 15px #0ff) drop-shadow(0 0 25px #0ff) drop-shadow(0 0 35px #0ff);
                transform: translateY(-5px);
            }
        }

        @keyframes quoteFade {
            0%, 100% { opacity: 0; transform: translateY(10px); }
            10%, 90% { opacity: 1; transform: translateY(0); }
        }

        @keyframes scanline {
            0% { 
                transform: translateY(-100%); 
                opacity: 1;
            }
            100% { 
                transform: translateY(100vh); 
                opacity: 1;
            }
        }

        body {
            font-family: 'Courier New', monospace;
            background: #0a0a0f;
            color: #0ff;
            min-height: 100vh;
            position: relative;
            overflow-x: hidden;
        }

        .scanline {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 2px;
            background: linear-gradient(to right, transparent, #0ff, transparent);
            animation: scanline 4s linear;
            pointer-events: none;
            z-index: 1000;
            opacity: 0;
        }

        .container {
            max-width: 1600px;
            margin: 0 auto;
            padding: 20px;
            position: relative;
            z-index: 2;
        }

        header {
            text-align: center;
            padding: 20px;
            background: rgba(0, 20, 40, 0.9);
            border: 2px solid #0ff;
            border-radius: 10px;
            margin-bottom: 20px;
            animation: slideIn 0.5s ease-out;
            box-shadow: 0 0 20px rgba(0, 255, 255, 0.3);
        }

        h1 {
            font-size: 2.5em;
            letter-spacing: 4px;
            margin-bottom: 10px;
            color: #0ff;
            animation: glow 2s infinite;
        }

        /* Cyberpunk Upload Zone */
        .upload-zone {
            background: rgba(0, 20, 40, 0.7);
            border: 2px dashed #0ff;
            border-radius: 10px;
            padding: 40px;
            text-align: center;
            margin: 20px 0;
            cursor: pointer;
            transition: all 0.3s;
            position: relative;
            overflow: hidden;
        }

        .upload-zone:hover {
            background: rgba(0, 40, 80, 0.8);
            border-color: #f0f;
            box-shadow: 0 0 30px rgba(0, 255, 255, 0.5);
        }

        .upload-zone::before {
            content: '';
            position: absolute;
            top: -50%;
            left: -50%;
            width: 200%;
            height: 200%;
            background: linear-gradient(
                45deg,
                transparent 30%,
                rgba(0, 255, 255, 0.1) 50%,
                transparent 70%
            );
            animation: slideGlow 3s infinite linear;
            pointer-events: none;
        }

        @keyframes slideGlow {
            0% { transform: translateX(-100%) translateY(-100%); }
            100% { transform: translateX(100%) translateY(100%); }
        }

        .upload-icon {
            font-size: 5em;
            margin-bottom: 15px;
            display: inline-block;
            animation: cyberGlow 2s infinite ease-in-out;
            position: relative;
        }

        .upload-icon::before {
            content: "ðŸ“‚";
            font-size: 5em;
            display: block;
            filter: hue-rotate(180deg) brightness(1.5);
            text-shadow: 
                0 0 10px #0ff,
                0 0 20px #0ff,
                0 0 30px #0ff,
                0 0 40px #0ff;
        }

        .upload-text {
            font-size: 1.2em;
            margin: 10px 0;
            color: #0ff;
            text-transform: uppercase;
            letter-spacing: 2px;
        }

        .upload-subtext {
            font-size: 0.9em;
            opacity: 0.7;
            color: #88ffff;
        }

        /* Quotes Container */
        .quotes-container {
            background: rgba(0, 20, 40, 0.5);
            border: 1px solid rgba(0, 255, 255, 0.3);
            border-radius: 8px;
            padding: 20px;
            margin: 30px auto;
            max-width: 800px;
            min-height: 120px;
            position: relative;
            overflow: hidden;
        }

        .quote {
            position: absolute;
            width: 100%;
            text-align: center;
            font-size: 1.1em;
            line-height: 1.4;
            color: #aaffff;
            padding: 0 20px;
            animation: quoteFade 15s infinite;
            text-shadow: 0 0 10px rgba(0, 255, 255, 0.5);
            font-style: italic;
        }

        /* Different animation delays for smooth transitions */
        .quote:nth-child(1) { animation-delay: 0s; }
        .quote:nth-child(2) { animation-delay: 15s; }
        .quote:nth-child(3) { animation-delay: 30s; }
        .quote:nth-child(4) { animation-delay: 45s; }
        .quote:nth-child(5) { animation-delay: 60s; }
        .quote:nth-child(6) { animation-delay: 75s; }
        .quote:nth-child(7) { animation-delay: 90s; }
        .quote:nth-child(8) { animation-delay: 105s; }

        /* Rest of the existing styles remain the same */
        .data-summary {
            background: rgba(0, 40, 80, 0.8);
            border: 2px solid #0ff;
            border-radius: 10px;
            padding: 20px;
            margin: 20px 0;
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
            gap: 15px;
            animation: fadeIn 0.5s;
        }

        /* ... (all other existing styles remain exactly as they were) ... */

        @media (max-width: 768px) {
            h1 {
                font-size: 1.8em;
                letter-spacing: 2px;
            }

            .upload-icon {
                font-size: 3.5em;
            }

            .upload-text {
                font-size: 1em;
            }

            .quote {
                font-size: 0.9em;
                padding: 0 10px;
            }

            .bar-chart-grid {
                grid-template-columns: 1fr;
            }

            .sensor-checkboxes {
                grid-template-columns: repeat(auto-fill, minmax(120px, 1fr));
            }
        }
    </style>
</head>
<body>
    <div class="scanline"></div>
    
    <div class="container">
        <header>
            <h1>CPIL CHENNAI</h1>
            <div style="font-size: 1.2em; color: #0af;">DRYER CHAMBER TEMPERATURE ANALYTICS</div>
        </header>

        <div id="uploadSection">
            <div class="upload-zone" onclick="document.getElementById('csvFile').click()">
                <div class="upload-icon"></div>
                <div class="upload-text">UPLOAD CSV DATA FILE</div>
                <div class="upload-subtext">Click here or drag & drop your CSV file</div>
            </div>
            
            <!-- Quotes Section -->
            <div class="quotes-container">
                <div class="quote">Quality survives when processes are never left unattended.</div>
                <div class="quote">Excellence begins where blind spots end.</div>
                <div class="quote">What you observe early never becomes a crisis.</div>
                <div class="quote">Awareness is the first defense of quality.</div>
                <div class="quote">Quality is maintained by attention, not intention.</div>
                <div class="quote">Silent processes fail the loudest.</div>
                <div class="quote">Visibility turns routine work into reliable performance.</div>
                <div class="quote">Data is quality's conscience.</div>
            </div>
            
            <input type="file" id="csvFile" accept=".csv" />
        </div>

        <!-- The rest of the HTML remains exactly the same -->
        <div id="dataSummary" class="data-summary" style="display: none;"></div>

        <div id="controlsSection" style="display: none;">
            <div class="controls-panel">
                <div class="filter-type-selector">
                    <button class="filter-type-btn active" onclick="setFilterType('predefined')">Predefined Time Range</button>
                    <button class="filter-type-btn" onclick="setFilterType('custom')">Custom Date/Time Range</button>
                    <button class="filter-type-btn" onclick="setFilterType('shiftwise')">Shiftwise Analysis</button>
                </div>

                <!-- Predefined Time Range Section -->
                <div id="predefinedSection" class="filter-section active">
                    <div class="filter-section-title" id="predefinedTitle">PREDEFINED TIME RANGE</div>
                    <div class="time-range-grid">
                        <button class="time-range-btn" data-range="1h" onclick="setTimeRange('1h')">Last 1 Hour</button>
                        <button class="time-range-btn" data-range="6h" onclick="setTimeRange('6h')">Last 6 Hours</button>
                        <button class="time-range-btn" data-range="12h" onclick="setTimeRange('12h')">Last 12 Hours</button>
                        <button class="time-range-btn active" data-range="24h" onclick="setTimeRange('24h')">Last 24 Hours</button>
                        <button class="time-range-btn" data-range="3d" onclick="setTimeRange('3d')">Last 3 Days</button>
                        <button class="time-range-btn" data-range="7d" onclick="setTimeRange('7d')">Last 7 Days</button>
                        <button class="time-range-btn" data-range="all" onclick="setTimeRange('all')">All Data</button>
                    </div>
                </div>

                <!-- Custom Date/Time Range Section -->
                <div id="customSection" class="filter-section">
                    <div class="filter-section-title">CUSTOM DATE & TIME RANGE</div>
                    <div class="custom-range-grid">
                        <div class="date-time-input">
                            <label>Start Date & Time</label>
                            <div class="date-time-row">
                                <input type="date" id="customStartDate">
                                <input type="time" id="customStartTime">
                            </div>
                        </div>
                        <div class="date-time-input">
                            <label>End Date & Time</label>
                            <div class="date-time-row">
                                <input type="date" id="customEndDate">
                                <input type="time" id="customEndTime">
                            </div>
                        </div>
                    </div>
                </div>

                <!-- Shiftwise Analysis Section -->
                <div id="shiftwiseSection" class="filter-section">
                    <div class="filter-section-title">SHIFTWISE ANALYSIS</div>
                    
                    <div class="shift-grid">
                        <button class="shift-btn active" data-shift="8hour" onclick="setShift('8hour')">8-Hour Shiftwise</button>
                        <button class="shift-btn" data-shift="12hour" onclick="setShift('12hour')">12-Hour Shiftwise</button>
                    </div>

                    <div style="display: flex; gap: 15px; align-items: flex-end; justify-content: center; margin: 15px 0; flex-wrap: wrap;">
                        <div class="shift-date-selector" style="margin: 0;">
                            <label>Select Date</label>
                            <input type="date" id="shiftDate">
                        </div>
                        <div style="padding-bottom: 2px;">
                            <button class="view-toggle" id="shiftToggleBtn" onclick="toggleShiftView()" style="display: none;">
                                <span id="toggleBtnText">View Side-by-Side</span>
                            </button>
                        </div>
                    </div>
                </div>

                <!-- Chamber Selection -->
                <div class="filter-section-title" style="margin-top: 20px;">SELECT CHAMBERS</div>
                <div class="sensor-checkboxes" id="sensorCheckboxes"></div>

                <!-- Action Buttons -->
                <div class="action-buttons">
                    <button onclick="applyFilters()">Apply Filter</button>
                    <button class="reset" onclick="resetFilters()">Reset</button>
                    <button class="export" onclick="exportScreenshot()">Export Screenshot</button>
                    <button class="upload-new" onclick="uploadNewFile()">Upload New CSV</button>
                </div>
            </div>
        </div>

        <div id="loading" class="loading">PROCESSING DATA...</div>

        <div id="chartsSection" style="display: none;">
            <!-- Main Temperature Trends Chart -->
            <div class="chart-container" id="mainChartContainer">
                <div class="chart-title">TEMPERATURE TRENDS</div>
                <canvas id="tempChart"></canvas>
            </div>

            <!-- Shift-wise Charts Container (for 8-hour and 12-hour shifts) -->
            <div id="shiftChartsContainer" class="shift-charts-container" style="display: none;"></div>

            <!-- Combined Statistics Section -->
            <div class="chart-container">
                <div class="chart-title">STATISTICS</div>
                
                <!-- Summary Cards -->
                <div id="statsGrid" class="stats-grid"></div>

                <!-- Bar Charts -->
                <div class="bar-chart-grid" id="barChartGrid">
                    <div class="bar-chart-item">
                        <div class="bar-chart-title">Average</div>
                        <canvas id="avgBarChart"></canvas>
                    </div>
                    <div class="bar-chart-item">
                        <div class="bar-chart-title">Minimum</div>
                        <canvas id="minBarChart"></canvas>
                    </div>
                    <div class="bar-chart-item">
                        <div class="bar-chart-title">Maximum</div>
                        <canvas id="maxBarChart"></canvas>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <script>
        // Add quotes array with all the quotes you provided
        const qualityQuotes = [
            "Quality survives when processes are never left unattended.",
            "Excellence begins where blind spots end.",
            "What you observe early never becomes a crisis.",
            "Awareness is the first defense of quality.",
            "Quality is maintained by attention, not intention.",
            "Silent processes fail the loudest.",
            "Visibility turns routine work into reliable performance.",
            "Data is quality's conscience.",
            "Consistency is born from constant awareness.",
            "Quality lives where nothing goes unchecked.",
            "Excellence is built by noticing small deviations.",
            "The best systems speak before they break.",
            "Quality improves when signals are heard in time.",
            "Problems grow only where attention fades.",
            "Stability is a result of disciplined observation.",
            "Quality is protected by curiosity.",
            "What you track quietly protects your reputation loudly.",
            "Reliability is sustained by continuous feedback.",
            "Excellence is a habit of watching details.",
            "Quality is lost when assumptions replace evidence.",
            "Early signals prevent late surprises.",
            "Control starts with knowing what is happening now.",
            "Quality thrives under informed awareness.",
            "Systems fail slowlyâ€”until someone is paying attention.",
            "Precision depends on constant insight.",
            "Quality is a result of informed vigilance.",
            "When data speaks, excellence listens.",
            "Attention today saves correction tomorrow.",
            "Quality is not luck; it is awareness in action.",
            "Consistency is maintained by never looking away.",
            "Excellence is sustained by timely insight.",
            "Quality gaps appear where visibility disappears.",
            "Stability is achieved through continuous sensing.",
            "Reliable outcomes come from informed processes.",
            "Quality strengthens when feedback loops are tight.",
            "What you see clearly, you can improve confidently.",
            "Quality is preserved by early detection.",
            "Excellence is the reward of disciplined attention.",
            "Small signals guide big improvements.",
            "Quality depends on what you notice, not what you hope.",
            "Insight is the engine of quality control.",
            "Quality is protected by knowing the process pulse.",
            "Awareness turns operations into outcomes.",
            "Excellence grows where facts replace assumptions.",
            "Quality is a system that listens.",
            "Control is achieved through constant insight.",
            "Processes perform best when they are never ignored.",
            "Quality is maintained by staying alert to change.",
            "Excellence is built by seeing before reacting.",
            "Quality succeeds where nothing escapes attention.",
            "Quality excellence is a result of disciplined monitoring.",
            "Monitoring turns variability into control.",
            "Monitoring aligns people, process, and performance.",
            "Without monitoring, quality drifts.",
            "Monitoring is the key that locks in consistency.",
            "Quality excellence is sustained by what we watch every day.",
            "Monitoring is not optionalâ€”it is the backbone of quality excellence",
            "Monitoring turns quality goals into achievable outcomes.",
            "Small deviations caught by monitoring prevent big failures.",
            "Monitoring is prevention, not inspection.",
            "Quality excellence grows where monitoring is consistent.",
            "Monitoring gives quality a voice."
        ];

        // Initialize quotes when page loads
        document.addEventListener('DOMContentLoaded', function() {
            initializeQuotes();
        });

        function initializeQuotes() {
            const quotesContainer = document.querySelector('.quotes-container');
            if (!quotesContainer) return;

            // Clear existing quotes
            quotesContainer.innerHTML = '';

            // Select 8 random quotes from the array
            const selectedQuotes = [];
            const quoteIndices = new Set();
            
            while (selectedQuotes.length < 8 && quoteIndices.size < qualityQuotes.length) {
                const randomIndex = Math.floor(Math.random() * qualityQuotes.length);
                if (!quoteIndices.has(randomIndex)) {
                    quoteIndices.add(randomIndex);
                    selectedQuotes.push(qualityQuotes[randomIndex]);
                }
            }

            // Add quotes to container
            selectedQuotes.forEach((quote, index) => {
                const quoteElement = document.createElement('div');
                quoteElement.className = 'quote';
                quoteElement.style.animationDelay = `${index * 15}s`;
                quoteElement.textContent = quote;
                quotesContainer.appendChild(quoteElement);
            });

            // Update animation durations based on number of quotes
            const totalDuration = selectedQuotes.length * 15; // 15 seconds per quote
            document.querySelectorAll('.quote').forEach(quote => {
                quote.style.animationDuration = `${totalDuration}s`;
            });
        }

        // Rest of the existing JavaScript remains exactly the same
        let rawData = [];
        let filteredData = [];
        let tempChart = null;
        let shiftCharts = [];
        let barCharts = [];
        let currentFilterType = 'predefined';
        let currentShift = '8hour';
        let currentTimeRange = '24h';
        let shiftViewMode = 'stacked'; // 'stacked' or 'sidebyside'
        let activeChambers = [];
        
        const colors = [
            '#00f5ff',  // Chamber 1 - Cyan
            '#ff00ff',  // Chamber 2 - Magenta
            '#00ff00',  // Chamber 3 - Green
            '#ffff00',  // Chamber 4 - Yellow
            '#ff8800',  // Chamber 5 - Orange
            '#8888ff',  // Chamber 6 - Blue
            '#ff0080',  // Chamber 7 - Pink
            '#80ff00',  // Chamber 8 - Lime
        ];

        // Initialize
        document.getElementById('csvFile').addEventListener('change', handleFileUpload);
        
        // Initialize date inputs to today
        const today = new Date().toISOString().split('T')[0];
        document.getElementById('customStartDate').value = today;
        document.getElementById('customStartTime').value = '00:00';
        document.getElementById('customEndDate').value = today;
        document.getElementById('customEndTime').value = '23:59';
        document.getElementById('shiftDate').value = today;

        function handleFileUpload(event) {
            const file = event.target.files[0];
            if (!file) return;

            showLoading(true);
            
            const reader = new FileReader();
            reader.onload = function(e) {
                try {
                    parseCSV(e.target.result);
                    document.getElementById('uploadSection').style.display = 'none';
                    document.getElementById('controlsSection').style.display = 'block';
                    document.getElementById('dataSummary').style.display = 'grid';
                    showLoading(false);
                } catch (error) {
                    console.error('Parse error:', error);
                    showError('Error parsing CSV file: ' + error.message);
                    showLoading(false);
                }
            };
            reader.readAsText(file);
        }

        function parseCSV(csvText) {
            const lines = csvText.trim().split('\n');
            
            rawData = [];
            let numSensors = 0;
            
            // Check if first line is a header
            const firstLine = lines[0].toLowerCase();
            const hasHeader = firstLine.includes('timestamp') || firstLine.includes('date') || firstLine.includes('time');
            const startIndex = hasHeader ? 1 : 0;
            
            for (let i = startIndex; i < lines.length; i++) {
                const values = lines[i].split(',').map(v => v.trim());
                if (values.length < 3) continue;
                
                let timestamp;
                let sensorStartIndex;
                
                // Check if first two columns are date and time
                if (values[0].includes('-') && values[1].includes(':')) {
                    // Date and time in separate columns (DD-MM-YYYY and HH:MM:SS)
                    const dateParts = values[0].split('-');
                    const timeParts = values[1].split(':');
                    
                    const day = parseInt(dateParts[0]);
                    const month = parseInt(dateParts[1]) - 1;
                    const year = parseInt(dateParts[2]);
                    const hour = parseInt(timeParts[0]);
                    const minute = parseInt(timeParts[1]);
                    const second = parseInt(timeParts[2] || 0);
                    
                    timestamp = new Date(year, month, day, hour, minute, second);
                    sensorStartIndex = 2;
                } else {
                    // Single timestamp column
                    timestamp = new Date(values[0]);
                    sensorStartIndex = 1;
                }
                
                const sensors = values.slice(sensorStartIndex).map(v => {
                    if (v === '' || v.toUpperCase() === 'OPEN' || v.toUpperCase() === 'B000') {
                        return null;
                    }
                    const num = parseFloat(v);
                    return isNaN(num) ? null : num;
                });
                
                if (numSensors === 0) {
                    numSensors = sensors.length;
                }
                
                rawData.push({
                    timestamp: timestamp,
                    sensors: sensors
                });
            }
            
            // Sort by timestamp
            rawData.sort((a, b) => a.timestamp - b.timestamp);
            
            // Identify active chambers (those that have at least some non-null data)
            activeChambers = [];
            for (let i = 0; i < numSensors; i++) {
                const hasData = rawData.some(item => item.sensors[i] !== null);
                if (hasData) {
                    activeChambers.push(i);
                }
            }
            
            // Update predefined title with last update time
            if (rawData.length > 0) {
                const lastUpdate = rawData[rawData.length - 1].timestamp;
                const dateStr = `${lastUpdate.getDate().toString().padStart(2, '0')}/${(lastUpdate.getMonth() + 1).toString().padStart(2, '0')}/${lastUpdate.getFullYear()}`;
                const timeStr = `${lastUpdate.getHours().toString().padStart(2, '0')}:${lastUpdate.getMinutes().toString().padStart(2, '0')}:${lastUpdate.getSeconds().toString().padStart(2, '0')}`;
                document.getElementById('predefinedTitle').textContent = `PREDEFINED TIME RANGE (Last Update: ${dateStr} ${timeStr})`;
            }
            
            // Generate sensor checkboxes (only for active chambers)
            generateSensorCheckboxes(numSensors);
            
            // Update data summary
            updateDataSummary();
            
            // Apply default filters
            applyFilters();
        }

        function updateDataSummary() {
            if (rawData.length === 0) return;
            
            const startDate = rawData[0].timestamp;
            const endDate = rawData[rawData.length - 1].timestamp;
            const duration = Math.round((endDate - startDate) / (1000 * 60 * 60)); // hours
            
            const summary = document.getElementById('dataSummary');
            summary.innerHTML = `
                <div class="summary-item">
                    <div class="summary-label">DATA POINTS</div>
                    <div class="summary-value">${rawData.length.toLocaleString()}</div>
                </div>
                <div class="summary-item">
                    <div class="summary-label">ACTIVE CHAMBERS</div>
                    <div class="summary-value">${activeChambers.length}</div>
                </div>
                <div class="summary-item">
                    <div class="summary-label">FROM</div>
                    <div class="summary-value">${startDate.getDate()}/${startDate.getMonth() + 1}/${startDate.getFullYear()}</div>
                </div>
                <div class="summary-item">
                    <div class="summary-label">TO</div>
                    <div class="summary-value">${endDate.getDate()}/${endDate.getMonth() + 1}/${endDate.getFullYear()}</div>
                </div>
                <div class="summary-item">
                    <div class="summary-label">DURATION</div>
                    <div class="summary-value">${duration} hours</div>
                </div>
            `;
        }

        function generateSensorCheckboxes(count) {
            const container = document.getElementById('sensorCheckboxes');
            container.innerHTML = '';
            
            for (let i = 0; i < count; i++) {
                const isActive = activeChambers.includes(i);
                
                const div = document.createElement('div');
                div.className = 'checkbox-item';
                div.style.borderColor = colors[i % colors.length];
                
                if (!isActive) {
                    div.style.opacity = '0.4';
                    div.style.cursor = 'not-allowed';
                }
                
                const checkbox = document.createElement('input');
                checkbox.type = 'checkbox';
                checkbox.id = `sensor${i}`;
                checkbox.checked = isActive;
                checkbox.disabled = !isActive;
                checkbox.onchange = applyFilters;
                
                const label = document.createElement('label');
                label.htmlFor = `sensor${i}`;
                label.textContent = `Chamber ${i + 1}${!isActive ? ' (NA)' : ''}`;
                label.style.color = colors[i % colors.length];
                
                div.appendChild(checkbox);
                div.appendChild(label);
                container.appendChild(div);
            }
        }

        function setFilterType(type) {
            currentFilterType = type;
            
            document.querySelectorAll('.filter-type-btn').forEach(btn => {
                btn.classList.remove('active');
            });
            event.target.classList.add('active');
            
            document.getElementById('predefinedSection').classList.remove('active');
            document.getElementById('customSection').classList.remove('active');
            document.getElementById('shiftwiseSection').classList.remove('active');
            
            // Hide/show toggle button based on filter type
            const toggleBtn = document.getElementById('shiftToggleBtn');
            if (type === 'shiftwise') {
                document.getElementById('shiftwiseSection').classList.add('active');
                toggleBtn.style.display = 'block';
            } else {
                toggleBtn.style.display = 'none';
                if (type === 'predefined') {
                    document.getElementById('predefinedSection').classList.add('active');
                } else if (type === 'custom') {
                    document.getElementById('customSection').classList.add('active');
                }
            }
        }

        function setTimeRange(range) {
            currentTimeRange = range;
            document.querySelectorAll('.time-range-btn').forEach(btn => {
                btn.classList.remove('active');
            });
            event.target.classList.add('active');
        }

        function setShift(shift) {
            currentShift = shift;
            document.querySelectorAll('.shift-btn').forEach(btn => {
                btn.classList.remove('active');
            });
            event.target.classList.add('active');
        }

        function applyFilters() {
            if (rawData.length === 0) return;

            showLoading(true);
            
            const selectedSensors = [];
            const checkboxes = document.querySelectorAll('#sensorCheckboxes input[type="checkbox"]');
            checkboxes.forEach((cb, index) => {
                if (cb.checked && !cb.disabled) selectedSensors.push(index);
            });

            if (selectedSensors.length === 0) {
                showError('Please select at least one active chamber');
                showLoading(false);
                return;
            }

            if (currentFilterType === 'predefined') {
                filterPredefinedRange(selectedSensors);
            } else if (currentFilterType === 'custom') {
                filterCustomRange(selectedSensors);
            } else if (currentFilterType === 'shiftwise') {
                filterShiftwise(selectedSensors);
            }
        }

        function filterPredefinedRange(selectedSensors) {
            // Use the latest timestamp in the data as the reference (device time)
            const latestTime = rawData[rawData.length - 1].timestamp;
            let startTime;

            switch(currentTimeRange) {
                case '1h':
                    startTime = new Date(latestTime.getTime() - 1 * 60 * 60 * 1000);
                    break;
                case '6h':
                    startTime = new Date(latestTime.getTime() - 6 * 60 * 60 * 1000);
                    break;
                case '12h':
                    startTime = new Date(latestTime.getTime() - 12 * 60 * 60 * 1000);
                    break;
                case '24h':
                    startTime = new Date(latestTime.getTime() - 24 * 60 * 60 * 1000);
                    break;
                case '3d':
                    startTime = new Date(latestTime.getTime() - 3 * 24 * 60 * 60 * 1000);
                    break;
                case '7d':
                    startTime = new Date(latestTime.getTime() - 7 * 24 * 60 * 60 * 1000);
                    break;
                case 'all':
                    startTime = rawData[0].timestamp;
                    break;
                default:
                    startTime = new Date(latestTime.getTime() - 24 * 60 * 60 * 1000);
            }

            filteredData = rawData.filter(item => item.timestamp >= startTime);

            if (filteredData.length === 0) {
                showError('No data found in the selected time range');
                showLoading(false);
                return;
            }

            updateCharts(selectedSensors, false);
            showLoading(false);
        }

        function filterCustomRange(selectedSensors) {
            const startDate = document.getElementById('customStartDate').value;
            const startTime = document.getElementById('customStartTime').value;
            const endDate = document.getElementById('customEndDate').value;
            const endTime = document.getElementById('customEndTime').value;

            if (!startDate || !startTime || !endDate || !endTime) {
                showError('Please select both start and end date/time');
                showLoading(false);
                return;
            }

            const startDateTime = new Date(`${startDate}T${startTime}`);
            const endDateTime = new Date(`${endDate}T${endTime}`);

            if (startDateTime >= endDateTime) {
                showError('End date/time must be after start date/time');
                showLoading(false);
                return;
            }

            filteredData = rawData.filter(item => 
                item.timestamp >= startDateTime && item.timestamp <= endDateTime
            );

            if (filteredData.length === 0) {
                showError('No data found in the selected time range');
                showLoading(false);
                return;
            }

            updateCharts(selectedSensors, false);
            showLoading(false);
        }

        function filterShiftwise(selectedSensors) {
            const shiftDate = document.getElementById('shiftDate').value;
            
            if (!shiftDate) {
                showError('Please select a date for shift analysis');
                showLoading(false);
                return;
            }

            const selectedDate = new Date(shiftDate);
            const shifts = currentShift === '8hour' ? 
                [
                    { name: 'Shift A (7AM - 3PM)', start: 7, end: 15 },
                    { name: 'Shift B (3PM - 11PM)', start: 15, end: 23 },
                    { name: 'Shift C (11PM - 7AM of next day)', start: 23, end: 31 }
                ] :
                [
                    { name: 'Shift A (7AM-7PM)', start: 7, end: 19 },
                    { name: 'Shift B (7PM-7AM of next day)', start: 19, end: 31 }
                ];

            const shiftDataArray = [];
            
            shifts.forEach(shift => {
                let shiftStart, shiftEnd;
                
                if (shift.start >= 24) {
                    shiftStart = new Date(selectedDate);
                    shiftStart.setDate(shiftStart.getDate() - 1);
                    shiftStart.setHours(shift.start - 24, 0, 0, 0);
                    
                    shiftEnd = new Date(selectedDate);
                    shiftEnd.setHours(shift.end - 24, 0, 0, 0);
                } else if (shift.end > 24) {
                    shiftStart = new Date(selectedDate);
                    shiftStart.setHours(shift.start, 0, 0, 0);
                    
                    shiftEnd = new Date(selectedDate);
                    shiftEnd.setDate(shiftEnd.getDate() + 1);
                    shiftEnd.setHours(shift.end - 24, 0, 0, 0);
                } else {
                    shiftStart = new Date(selectedDate);
                    shiftStart.setHours(shift.start, 0, 0, 0);
                    
                    shiftEnd = new Date(selectedDate);
                    shiftEnd.setHours(shift.end, 0, 0, 0);
                }

                const shiftData = rawData.filter(item => 
                    item.timestamp >= shiftStart && item.timestamp < shiftEnd
                );
                
                shiftDataArray.push({
                    name: shift.name,
                    data: shiftData
                });
            });

            const totalDataPoints = shiftDataArray.reduce((sum, shift) => sum + shift.data.length, 0);
            if (totalDataPoints === 0) {
                showError('No data found for the selected shift date');
                showLoading(false);
                return;
            }

            updateShiftCharts(selectedSensors, shiftDataArray);
            showLoading(false);
        }

        function updateCharts(selectedSensors, isShiftMode) {
            document.getElementById('chartsSection').style.display = 'block';
            document.getElementById('mainChartContainer').style.display = isShiftMode ? 'none' : 'block';
            document.getElementById('shiftChartsContainer').style.display = 'none';
            
            if (!isShiftMode) {
                const datasets = selectedSensors.map(sensorIndex => ({
                    label: `Chamber ${sensorIndex + 1}`,
                    data: filteredData.map(item => ({
                        x: item.timestamp,
                        y: item.sensors[sensorIndex]
                    })),
                    borderColor: colors[sensorIndex % colors.length],
                    backgroundColor: colors[sensorIndex % colors.length] + '20',
                    tension: 0.1,
                    spanGaps: true,
                    pointRadius: 0,
                    borderWidth: 2
                }));

                const ctx = document.getElementById('tempChart').getContext('2d');
                
                if (tempChart) {
                    tempChart.destroy();
                }

                tempChart = new Chart(ctx, {
                    type: 'line',
                    data: { datasets },
                    options: {
                        responsive: true,
                        maintainAspectRatio: true,
                        aspectRatio: 2.5,
                        plugins: {
                            legend: {
                                display: true,
                                position: 'bottom',
                                labels: {
                                    color: '#0ff',
                                    font: { family: 'Courier New', size: 12 }
                                }
                            },
                            tooltip: {
                                mode: 'index',
                                intersect: false,
                                backgroundColor: 'rgba(0, 20, 40, 0.9)',
                                titleColor: '#0ff',
                                bodyColor: '#0ff',
                                borderColor: '#0ff',
                                borderWidth: 1
                            }
                        },
                        scales: {
                            x: {
                                type: 'time',
                                time: {
                                    displayFormats: {
                                        hour: 'dd/MM/yyyy HH:mm',
                                        minute: 'dd/MM/yyyy HH:mm',
                                        day: 'dd/MM/yyyy'
                                    },
                                    tooltipFormat: 'dd/MM/yyyy HH:mm:ss'
                                },
                                ticks: { color: '#0ff', font: { family: 'Courier New', size: 10 } },
                                grid: { color: 'rgba(0, 255, 255, 0.1)' }
                            },
                            y: {
                                beginAtZero: false,
                                ticks: { 
                                    color: '#0ff',
                                    font: { family: 'Courier New' },
                                    callback: value => value + 'Â°C'
                                },
                                grid: { color: 'rgba(0, 255, 255, 0.1)' }
                            }
                        }
                    }
                });
            }

            updateStatistics(selectedSensors);
        }

        function updateShiftCharts(selectedSensors, shiftDataArray) {
            document.getElementById('chartsSection').style.display = 'block';
            document.getElementById('mainChartContainer').style.display = 'none';
            
            const container = document.getElementById('shiftChartsContainer');
            container.style.display = 'grid';
            container.className = 'shift-charts-container ' + shiftViewMode;
            
            // Clear existing shift charts
            shiftCharts.forEach(chart => chart.destroy());
            shiftCharts = [];
            
            container.innerHTML = '';
            
            // Create a chart for each shift
            shiftDataArray.forEach((shiftInfo, index) => {
                const chartDiv = document.createElement('div');
                chartDiv.className = 'chart-container';
                chartDiv.innerHTML = `
                    <div class="chart-title">${shiftInfo.name}</div>
                    <canvas id="shiftChart${index}"></canvas>
                `;
                container.appendChild(chartDiv);
                
                const datasets = selectedSensors.map(sensorIndex => ({
                    label: `Chamber ${sensorIndex + 1}`,
                    data: shiftInfo.data.map(item => ({
                        x: item.timestamp,
                        y: item.sensors[sensorIndex]
                    })),
                    borderColor: colors[sensorIndex % colors.length],
                    backgroundColor: colors[sensorIndex % colors.length] + '20',
                    tension: 0.1,
                    spanGaps: true,
                    pointRadius: 0,
                    borderWidth: 2
                }));
                
                const ctx = document.getElementById(`shiftChart${index}`).getContext('2d');
                const chart = new Chart(ctx, {
                    type: 'line',
                    data: { datasets },
                    options: {
                        responsive: true,
                        maintainAspectRatio: true,
                        aspectRatio: 2.0,
                        plugins: {
                            legend: {
                                display: true,
                                position: 'bottom',
                                labels: {
                                    color: '#0ff',
                                    font: { family: 'Courier New', size: 12 }
                                }
                            },
                            tooltip: {
                                mode: 'index',
                                intersect: false,
                                backgroundColor: 'rgba(0, 20, 40, 0.9)',
                                titleColor: '#0ff',
                                bodyColor: '#0ff',
                                borderColor: '#0ff',
                                borderWidth: 1
                            }
                        },
                        scales: {
                            x: {
                                type: 'time',
                                time: {
                                    displayFormats: {
                                        hour: 'dd/MM/yyyy HH:mm',
                                        minute: 'dd/MM/yyyy HH:mm',
                                        day: 'dd/MM/yyyy'
                                    },
                                    tooltipFormat: 'dd/MM/yyyy HH:mm:ss'
                                },
                                ticks: { color: '#0ff', font: { family: 'Courier New', size: 10 } },
                                grid: { color: 'rgba(0, 255, 255, 0.1)' }
                            },
                            y: {
                                beginAtZero: false,
                                ticks: { 
                                    color: '#0ff',
                                    font: { family: 'Courier New' },
                                    callback: value => value + 'Â°C'
                                },
                                grid: { color: 'rgba(0, 255, 255, 0.1)' }
                            }
                        }
                    }
                });
                
                shiftCharts.push(chart);
            });
            
            // Calculate statistics across all shifts
            filteredData = [];
            shiftDataArray.forEach(shift => {
                filteredData = filteredData.concat(shift.data);
            });
            filteredData.sort((a, b) => a.timestamp - b.timestamp);
            
            updateStatistics(selectedSensors);
        }

        function updateStatistics(selectedSensors) {
            const container = document.getElementById('statsGrid');
            let html = '';
            
            const barChartData = {
                labels: [],
                averages: [],
                minimums: [],
                maximums: []
            };
            
            if (selectedSensors.length > 1) {
                const overallValues = [];
                filteredData.forEach(item => {
                    selectedSensors.forEach(sensorIndex => {
                        const value = item.sensors[sensorIndex];
                        if (value !== null) overallValues.push(value);
                    });
                });
                
                if (overallValues.length > 0) {
                    const avg = (overallValues.reduce((a, b) => a + b, 0) / overallValues.length).toFixed(1);
                    const min = Math.min(...overallValues).toFixed(1);
                    const max = Math.max(...overallValues).toFixed(1);
                    
                    html += `
                        <div class="stat-card overall">
                            <div style="font-size: 0.9em; color: #fff;">OVERALL AVERAGE</div>
                            <div style="font-size: 1.5em; color: #fff;">${avg}Â°C</div>
                            <div style="font-size: 0.8em; color: #ccc;">Min: ${min}Â°C | Max: ${max}Â°C</div>
                        </div>
                    `;
                }
            }
            
            selectedSensors.forEach(sensorIndex => {
                const values = filteredData
                    .map(item => item.sensors[sensorIndex])
                    .filter(value => value !== null);
                
                barChartData.labels.push(`Chamber ${sensorIndex + 1}`);
                
                if (values.length === 0) {
                    html += `
                        <div class="stat-card" style="border-color: ${colors[sensorIndex % colors.length]}">
                            <div style="font-size: 0.9em; color: #0af;">CHAMBER ${sensorIndex + 1}</div>
                            <div style="font-size: 1.2em; color: #f00;">NO DATA</div>
                            <div style="font-size: 0.8em;">All values are OPEN/B000</div>
                        </div>
                    `;
                    
                    barChartData.averages.push(null);
                    barChartData.minimums.push(null);
                    barChartData.maximums.push(null);
                    return;
                }
                
                const avg = (values.reduce((a, b) => a + b, 0) / values.length).toFixed(1);
                const min = Math.min(...values).toFixed(1);
                const max = Math.max(...values).toFixed(1);
                
                html += `
                    <div class="stat-card" style="border-color: ${colors[sensorIndex % colors.length]}">
                        <div style="font-size: 0.9em; color: #0af;">CHAMBER ${sensorIndex + 1}</div>
                        <div style="font-size: 1.5em; color: ${colors[sensorIndex % colors.length]}">${avg}Â°C</div>
                        <div style="font-size: 0.8em;">Min: ${min}Â°C | Max: ${max}Â°C</div>
                    </div>
                `;
                
                barChartData.averages.push(parseFloat(avg));
                barChartData.minimums.push(parseFloat(min));
                barChartData.maximums.push(parseFloat(max));
            });
            
            container.innerHTML = html;
            updateBarCharts(barChartData);
        }

        function updateBarCharts(chartData) {
            barCharts.forEach(chart => chart.destroy());
            barCharts = [];
            
            const chartConfigs = [
                { id: 'avgBarChart', label: 'Average', data: chartData.averages },
                { id: 'minBarChart', label: 'Minimum', data: chartData.minimums },
                { id: 'maxBarChart', label: 'Maximum', data: chartData.maximums }
            ];
            
            chartConfigs.forEach(config => {
                const ctx = document.getElementById(config.id).getContext('2d');
                
                // Calculate Y-axis minimum (4 points below lowest value)
                const validValues = config.data.filter(v => v !== null);
                const minValue = validValues.length > 0 ? Math.min(...validValues) : 0;
                const yAxisMin = Math.max(0, Math.floor(minValue - 4));
                
                const chart = new Chart(ctx, {
                    type: 'bar',
                    data: {
                        labels: chartData.labels,
                        datasets: [{
                            label: config.label + ' Temperature',
                            data: config.data,
                            backgroundColor: config.data.map((value, index) => 
                                value !== null ? colors[index % colors.length] + '80' : '#66666680'
                            ),
                            borderColor: config.data.map((value, index) => 
                                value !== null ? colors[index % colors.length] : '#666666'
                            ),
                            borderWidth: 2
                        }]
                    },
                    options: {
                        responsive: true,
                        maintainAspectRatio: true,
                        aspectRatio: 1.2,
                        plugins: {
                            legend: { display: false },
                            tooltip: {
                                backgroundColor: 'rgba(0, 20, 40, 0.9)',
                                titleColor: '#0ff',
                                bodyColor: '#0ff',
                                borderColor: '#0ff',
                                borderWidth: 1,
                                callbacks: {
                                    label: context => context.parsed.y !== null ? context.parsed.y + 'Â°C' : 'No Data'
                                }
                            }
                        },
                        scales: {
                            x: {
                                ticks: { 
                                    color: '#0ff',
                                    font: { family: 'Courier New', size: 10 }
                                },
                                grid: { color: 'rgba(0, 255, 255, 0.1)' }
                            },
                            y: {
                                beginAtZero: false,
                                min: yAxisMin,
                                ticks: { 
                                    color: '#0ff',
                                    font: { family: 'Courier New' },
                                    callback: value => value + 'Â°C'
                                },
                                grid: { color: 'rgba(0, 255, 255, 0.1)' }
                            }
                        }
                    }
                });
                
                barCharts.push(chart);
            });
        }

        function resetFilters() {
            setFilterType('predefined');
            document.querySelectorAll('.filter-type-btn').forEach((btn, idx) => {
                btn.classList.remove('active');
                if (idx === 0) btn.classList.add('active');
            });
            
            currentTimeRange = '24h';
            document.querySelectorAll('.time-range-btn').forEach(btn => {
                btn.classList.remove('active');
                if (btn.getAttribute('data-range') === '24h') {
                    btn.classList.add('active');
                }
            });
            
            const today = new Date().toISOString().split('T')[0];
            document.getElementById('customStartDate').value = today;
            document.getElementById('customStartTime').value = '00:00';
            document.getElementById('customEndDate').value = today;
            document.getElementById('customEndTime').value = '23:59';
            document.getElementById('shiftDate').value = today;
            
            currentShift = '8hour';
            document.querySelectorAll('.shift-btn').forEach((btn, idx) => {
                btn.classList.remove('active');
                if (idx === 0) btn.classList.add('active');
            });
            
            applyFilters();
        }

        function uploadNewFile() {
            if (confirm('Are you sure you want to upload a new CSV file? Current data will be cleared.')) {
                rawData = [];
                filteredData = [];
                activeChambers = [];
                if (tempChart) tempChart.destroy();
                shiftCharts.forEach(chart => chart.destroy());
                shiftCharts = [];
                barCharts.forEach(chart => chart.destroy());
                barCharts = [];
                
                document.getElementById('uploadSection').style.display = 'block';
                document.getElementById('controlsSection').style.display = 'none';
                document.getElementById('chartsSection').style.display = 'none';
                document.getElementById('dataSummary').style.display = 'none';
                
                document.getElementById('csvFile').value = '';
            }
        }

        function exportScreenshot() {
            // Hide loading indicator
            const loadingEl = document.getElementById('loading');
            loadingEl.style.display = 'none';
            
            // Force a repaint
            document.body.style.display = 'none';
            document.body.offsetHeight;
            document.body.style.display = '';
            
            // Wait for charts to fully render
            setTimeout(() => {
                const container = document.querySelector('.container');
                
                html2canvas(container, {
                    backgroundColor: '#0a0a0f',
                    scale: 2,
                    logging: false,
                    useCORS: true,
                    allowTaint: true,
                    imageTimeout: 0,
                    removeContainer: false
                }).then(canvas => {
                    // Convert to blob and create download
                    canvas.toBlob(function(blob) {
                        const url = URL.createObjectURL(blob);
                        const link = document.createElement('a');
                        link.download = `CPIL_Analytics_${new Date().toISOString().slice(0,19).replace(/:/g,'-')}.png`;
                        link.href = url;
                        link.click();
                        URL.revokeObjectURL(url);
                    }, 'image/png', 1.0);
                }).catch(error => {
                    console.error('Screenshot error:', error);
                    showError('Failed to export screenshot');
                });
            }, 800);
        }

        function toggleShiftView() {
            shiftViewMode = shiftViewMode === 'stacked' ? 'sidebyside' : 'stacked';
            const container = document.getElementById('shiftChartsContainer');
            const toggleText = document.getElementById('toggleBtnText');
            
            container.className = 'shift-charts-container ' + shiftViewMode;
            toggleText.textContent = shiftViewMode === 'stacked' ? 'View Side-by-Side' : 'Stack Vertically';
            
            // Resize charts to fit new layout
            setTimeout(() => {
                shiftCharts.forEach(chart => chart.resize());
            }, 100);
        }

        function showLoading(show) {
            document.getElementById('loading').style.display = show ? 'block' : 'none';
        }

        function showError(message) {
            const errorDiv = document.createElement('div');
            errorDiv.className = 'error';
            errorDiv.textContent = message;
            
            document.querySelectorAll('.error').forEach(el => el.remove());
            
            document.querySelector('.container').appendChild(errorDiv);
            
            setTimeout(() => errorDiv.remove(), 5000);
        }

        document.addEventListener('click', function(e) {
            if (e.target.tagName === 'BUTTON' || e.target.closest('button')) {
                const button = e.target.tagName === 'BUTTON' ? e.target : e.target.closest('button');
                const rect = button.getBoundingClientRect();
                
                const ripple = document.createElement('span');
                ripple.style.cssText = `
                    position: absolute;
                    border-radius: 50%;
                    background: rgba(0, 255, 255, 0.3);
                    transform: scale(0);
                    animation: ripple 0.6s linear;
                    width: ${Math.max(rect.width, rect.height)}px;
                    height: ${Math.max(rect.width, rect.height)}px;
                    left: ${e.clientX - rect.left - Math.max(rect.width, rect.height)/2}px;
                    top: ${e.clientY - rect.top - Math.max(rect.width, rect.height)/2}px;
                    pointer-events: none;
                `;
                
                button.style.position = 'relative';
                button.style.overflow = 'hidden';
                button.appendChild(ripple);
                
                setTimeout(() => ripple.remove(), 600);
            }
        });

        window.addEventListener('load', () => {
            const scanline = document.querySelector('.scanline');
            scanline.style.opacity = '1';
        });
    </script>
</body>
</html>